window.fbAsyncInit = function() {
   FB.init({
      appId      : '800212700114821',
      xfbml      : true,
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      version    : 'v2.6'
   });
};

(function(d, s, id){
   var js, fjs = d.getElementsByTagName(s)[0];
   if (d.getElementById(id)) {return;}
   js = d.createElement(s); js.id = id;
   js.src = "//connect.facebook.net/en_US/sdk.js";
   fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

// function login(){
//    console.log("login() ->");
//    FB.login(function(response){
//       if( response.status === 'connected'){
//          console.log("Connected");
//       } else if (response.status === 'not_authorized'){
//          console.log("not authorized");
//       } else{
//          alert("DUDE");
//       }
//    }, {scope: 'public_profile,user_photos,user_likes'});
// }
function makeFacebookPhotoURL( id, accessToken ) {
   return 'https://graph.facebook.com/' + id + '/picture?access_token=' + accessToken;
}

function FBLogin(callback){
   FB.login(function(response){
      if( response.status === 'connected'){
         callback(response);
         // console.log("Connected");
      } else if (response.status === 'not_authorized'){
         callback(response);
         // console.log("not authorized");
      } else{
         callback(response);
         // alert("DUDE");
      }
   }, {scope: 'public_profile,user_photos,user_likes'});
}

function getAlbums( callback ) {
   FB.api('/me/albums', {fields: 'id,cover_photo'},
   function(albumResponse) {
      if (callback) {
         callback(albumResponse);
      }
   });
}

function getPhotosForAlbumId( albumId, callback ) {
   FB.api('/'+albumId+'/photos',{fields: 'id, created_time, height, width, images, name'},
   function(albumPhotosResponse) {
      if (callback) {
         callback( albumId, albumPhotosResponse );
      }
   });
}

function getLikesForPhotoId( photoId ,callback ) {
   FB.api('/' + photoId+'/likes?limit=999999','GET', {"limit":"99999999"},
   function(photoLikesResponse) {
      if (callback) {
         callback(photoId, photoLikesResponse);
      }
   });
}

function getAllPhotos(callback){
   var allPhotos = [];
   var accessToken = '';
   FBLogin(function(loginResponse){
      accessToken = loginResponse.authResponse.accessToken;
      console.log(loginResponse.authResponse.accessToken);
      var i, album, deferreds = {}, listOfDeferreds = [];
      getAlbums(function(getAlbumsResponse){
         // console.log(getAlbumsResponse.data.length);
         for (i = 0; i < getAlbumsResponse.data.length; i++) {
            album = getAlbumsResponse.data[i];
            deferreds[album.id] = $.Deferred();
            listOfDeferreds.push( deferreds[album.id] );
            getPhotosForAlbumId( album.id, function( albumId, albumPhotosResponse ) {
               var i, facebookPhoto;
               for (i = 0; i < albumPhotosResponse.data.length; i++) {
                  facebookPhoto = albumPhotosResponse.data[i];
                  // console.log('album-id : ' + album.id);
                  // console.log('photo-id : '	+ facebookPhoto.id);
                  // console.log('added : '	+	facebookPhoto.created_time);
                  // console.log('url : '	+	makeFacebookPhotoURL( facebookPhoto.id, accessToken ));
                  var highResImg = facebookPhoto.images[0];
                  allPhotos.push({
                     'album_id'  : album.id,
                     'photo_id'	: facebookPhoto.id,
                     'added'	   : facebookPhoto.created_time,
                     'height'    : highResImg.height,
                     'width'     : highResImg.width,
                     'source'	   : highResImg.source,
                     'photo_name': facebookPhoto.name
                  });
               }
               deferreds[albumId].resolve();
            });

         }
         $.when.apply($, listOfDeferreds ).then( function() {
            if (callback) {
               callback( allPhotos );
            }
         }, function( error ) {
            if (callback) {
               callback( allPhotos, error );
            }
         });
      });
   });
}

function getAllLikes(callback){
   var allPhotosWithLikes = [];
   getAllPhotos(function(allPhotosResponse){
      // console.log(allPhotosResponse);
      // var allPhotos = allPhotosResponse;
      var i, photo, deferreds = {}, listOfDeferreds = [];
      for(var i = 0; i < allPhotosResponse.length; i++){
         // console.log(allPhotos[i].photo_id);
         // console.log(allPhotos[i].source);
         photo = allPhotosResponse[i];
         // console.log("Album id : " + allPhotosResponse[i].album_id);
         // console.log("Photo id : " + allPhotosResponse[i].photo_id);
         // console.log("Source : " + allPhotosResponse[i].source);
         // console.log("Photo id (photo) : " + photo.photo_id);
         // console.log("Source (photo) : " + photo.source);
         // console.log("Likes  : " + allPhotosResponse[i].likes);
         // console.log("Name : " + allPhotosResponse[i].photo_name);
         // console.log("Height : " + allPhotosResponse[i].height);
         // console.log("Width  : " + allPhotosResponse[i].width);
         // console.log(photo);
         // console.log(photo.photo_id);
         deferreds[photo.photo_id] = $.Deferred();
         listOfDeferreds.push( deferreds[photo.photo_id] );
         getLikesForPhotoId(photo.photo_id, function(photoId, likesResponse){
            // console.log(likesResponse);
            photo.likes = likesResponse.data.length;
            // console.log("Source : " + allPhotosResponse[i].source);
            // console.log("Album id : " + photo.album_id);
            // console.log("Photo id : " + photo.photo_id);
            // console.log("Source : " + photo.source);
            // console.log("Likes  : " + photo.likes);
            // console.log("Name : " + photo.photo_name);
            // console.log("Height : " + photo.height);
            // console.log("Width  : " + photo.width);
            allPhotosWithLikes.push(photo);
            // console.log(allPhotosWithLikes.length);
            deferreds[photoId].resolve();
         });
      }
      $.when.apply($, listOfDeferreds ).then( function() {
         if (callback) {
            callback( allPhotosWithLikes );
         }
      }, function( error ) {
         if (callback) {
            callback( allPhotosWithLikes, error );
         }
      });
   });

   // console.log("Album id : " + allPhotos[2].album_id);
   // console.log("Photo id : " + allPhotos[2].photo_id);
   // console.log("Source : " + allPhotos[2].source);
   // console.log("Height : " + allPhotos[2].height);
   // console.log("Width  : " + allPhotos[2].width);
   // console.log("Likes  : " + allPhotos[2].likes);
   // deferreds[albumId].resolve();
}

function sortPhotos(allPhotos){
   var sortedPhotos = _.sortBy( allPhotos, 'likes' );
   // console.log(sortedPhotos);
   return (sortedPhotos);
}

function login(){
   getAllLikes(function(allLikesResponse){
      console.log(allLikesResponse);
      var sortedPhotos = sortPhotos(allLikesResponse);
      var top_25_img = $('.top-25-img');
      var top_25_lbox = $('.top-25-lbox');
      // console.log(allLikesResponse.length);
      // var allPhotos = allLikesResponse;
      // var sortedPhotos = _.sortBy( allLikesResponse, 'likes' );
      // console.log(_.sortBy( allPhotos, 'likes' ));
      // console.log("Album id : " + allLikesResponse[2].album_id);
      // console.log("Photo id : " + allLikesResponse[2].photo_id);
      // console.log("Source : " + allLikesResponse[2].source);
      // console.log("Height : " + allLikesResponse[2].height);
      // console.log("Width  : " + allLikesResponse[2].width);
      // console.log("Likes  : " + allLikesResponse[0].likes);
      console.log(allLikesResponse.length);
      // console.log(sortedPhotos);
      for(i = 0; i < 25 ; i++){
         top_25_img.eq(i).attr('src', sortedPhotos[i].source);
         top_25_lbox.eq(i).attr('href', sortedPhotos[i].source);
         // console.log(sortedPhotos[i].source);
         // top_25_img.eq(i).attr('src', allPhotos[i].source);
         // top_25_lbox.eq(i).attr('href', allPhotos[i].source);
         // console.log(allPhotos[i].likes);
         top_25_img.eq(i).fadeIn(2000);
      }
      $('#FBAuthorized').fadeIn();
   });
}
// THis is for all photos
// for(i = 0; i < allPhotos.length; i++){
//    getLikesForPhotoId(allPhotos[i].photo_id, function(likesResponse){
//       allPhotos[i].likes = likesResponse.data.length;
//       console.log(allPhotos[i]);
//       // allPhotos[i].likes = likes
//    });
// }

// function myFunction(val, callBack){
//    if(val == 1){
//       callBack(true);
//    }else{
//       callBack(false);
//    }
// }
//
// myFunction(0, function (bool){
//    if(bool){
//       alert("do stuff for when value is true");
//    }else {
//       //this condition is satisfied as 0 passed
//       alert("do stuff for when value is false");
//    }
// });
